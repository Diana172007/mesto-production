(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const c of n)if(c.type==="childList")for(const i of c.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function o(n){const c={};return n.integrity&&(c.integrity=n.integrity),n.referrerPolicy&&(c.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?c.credentials="include":n.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function r(n){if(n.ep)return;n.ep=!0;const c=o(n);fetch(n.href,c)}})();const j=(e,{onPreviewPicture:t,onLikeIcon:o,onDeleteCard:r,userId:n})=>{const i=document.getElementById("card-template").content.querySelector(".card").cloneNode(!0);i.dataset.cardId=e._id;const a=i.querySelector(".card__like-button"),d=i.querySelector(".card__control-button_type_delete"),y=i.querySelector(".card__image"),C=i.querySelector(".card__like-count"),L=i.querySelector(".card__title");return y.src=e.link,y.alt=e.name,L.textContent=e.name,C&&(C.textContent=e.likes?e.likes.length:0),n&&e.likes&&e.likes.some(p=>p._id===n)&&a.classList.add("card__like-button_is-active"),n&&e.owner&&e.owner._id!==n&&d.remove(),o&&a.addEventListener("click",()=>o(a,e._id)),r&&d.addEventListener("click",()=>r(i,e._id)),t&&y.addEventListener("click",()=>t({name:e.name,link:e.link})),i},H=e=>{if(e.key==="Escape"){const t=document.querySelector(".popup_is-opened");f(t)}},m=e=>{e.classList.add("popup_is-opened"),document.addEventListener("keyup",H)},f=e=>{e.classList.remove("popup_is-opened"),document.removeEventListener("keyup",H)},Y=e=>{e.querySelector(".popup__close").addEventListener("click",()=>{f(e)}),e.addEventListener("mousedown",o=>{o.target.classList.contains("popup")&&f(e)})};function Z(e,t,o,r){const n=e.querySelector(`#${t.id}-error`);n.textContent=o,n.classList.add(r.errorClass),t.classList.add(r.inputErrorClass)}function J(e,t,o){const r=e.querySelector(`#${t.id}-error`);r.textContent="",r.classList.remove(o.errorClass),t.classList.remove(o.inputErrorClass)}function ee(e,t,o){t.validity.valid?J(e,t,o):Z(e,t,t.validationMessage,o)}function te(e){return e.some(t=>!t.validity.valid)}function O(e,t,o){te(e)?(t.classList.add(o.inactiveButtonClass),t.disabled=!0):(t.classList.remove(o.inactiveButtonClass),t.disabled=!1)}function oe(e,t){const o=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);O(o,r,t),o.forEach(n=>{n.addEventListener("input",function(){ee(e,n,t),O(o,r,t)})})}function ne(e){Array.from(document.querySelectorAll(e.formSelector)).forEach(o=>{oe(o,e)})}function x(e,t){const o=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);o.forEach(n=>{J(e,n,t)}),r.classList.add(t.inactiveButtonClass),r.disabled=!0}const s={baseUrl:"https://mesto.nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"b467a041-a34e-4276-a457-166468e85eb0","Content-Type":"application/json"}};function h(e){return e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)}function re(){return fetch(`${s.baseUrl}/users/me`,{headers:s.headers}).then(h)}function V(){return fetch(`${s.baseUrl}/cards`,{headers:s.headers}).then(h)}function ce({name:e,about:t}){return fetch(`${s.baseUrl}/users/me`,{method:"PATCH",headers:s.headers,body:JSON.stringify({name:e,about:t})}).then(h)}function ie({avatar:e}){return fetch(`${s.baseUrl}/users/me/avatar`,{method:"PATCH",headers:s.headers,body:JSON.stringify({avatar:e})}).then(h)}function se({name:e,link:t}){return fetch(`${s.baseUrl}/cards`,{method:"POST",headers:s.headers,body:JSON.stringify({name:e,link:t})}).then(h)}function ae(e){return fetch(`${s.baseUrl}/cards/${e}`,{method:"DELETE",headers:s.headers}).then(h)}function le(e,t){return fetch(`${s.baseUrl}/cards/likes/${e}`,{method:t?"DELETE":"PUT",headers:s.headers}).then(h)}const S={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},z=document.querySelector(".places__list"),U=document.querySelector(".popup_type_edit"),g=U.querySelector(".popup__form"),R=g.querySelector(".popup__input_type_name"),K=g.querySelector(".popup__input_type_description"),P=document.querySelector(".popup_type_new-card"),_=P.querySelector(".popup__form"),ue=_.querySelector(".popup__input_type_card-name"),de=_.querySelector(".popup__input_type_url"),T=document.querySelector(".popup_type_image"),D=T.querySelector(".popup__image"),pe=T.querySelector(".popup__caption"),w=document.querySelector(".popup_type_remove-card"),me=w.querySelector(".popup__form"),B=document.querySelector(".popup_type_edit-avatar"),v=B.querySelector(".popup__form"),fe=v.querySelector(".popup__input"),_e=document.querySelector(".profile__edit-button"),he=document.querySelector(".profile__add-button"),F=document.querySelector(".profile__title"),M=document.querySelector(".profile__description"),$=document.querySelector(".profile__image"),k=document.querySelector("#popup-info"),W=document.querySelector(".header__logo");let q=null,E=null,N=null;const G=({name:e,link:t})=>{D.src=t,D.alt=e,pe.textContent=e,m(T)},ye=e=>{e.preventDefault();const t=e.submitter,o=t.textContent;t.textContent="Сохранение...",ce({name:R.value,about:K.value}).then(r=>{F.textContent=r.name,M.textContent=r.about,f(U)}).catch(()=>{}).finally(()=>t.textContent=o)},Ce=e=>{e.preventDefault();const t=e.submitter,o=t.textContent;t.textContent="Сохранение...",ie({avatar:fe.value}).then(r=>{$.style.backgroundImage=`url('${r.avatar}')`,f(B),v.reset()}).catch(()=>{}).finally(()=>t.textContent=o)},Q=(e,t)=>{const o=e.classList.contains("card__like-button_is-active"),r=e.closest(".card").querySelector(".card__like-count");let n=parseInt(r.textContent)||0;o?(e.classList.remove("card__like-button_is-active"),r.textContent=Math.max(0,n-1)):(e.classList.add("card__like-button_is-active"),r.textContent=n+1),le(t,o).then(c=>{r.textContent=c.likes.length,e.classList.toggle("card__like-button_is-active",c.likes.some(i=>i._id===q))})},X=(e,t)=>{E=e,N=t,m(w)},ve=e=>{e.preventDefault();const t=e.submitter,o=t.textContent;t.textContent="Удаление...",E&&E.remove(),f(w),ae(N).finally(()=>{t.textContent=o,E=null,N=null})},Se=e=>{e.preventDefault();const t=e.submitter,o=t.textContent;t.textContent="Создание...",se({name:ue.value,link:de.value}).then(r=>{z.prepend(j(r,{onPreviewPicture:G,onLikeIcon:Q,onDeleteCard:X,userId:q})),f(P),_.reset(),x(_,S)}).catch(()=>{}).finally(()=>t.textContent=o)};function Le(e){const t={totalUsers:new Set,totalLikes:0,maxLikes:0,championName:"—",popularCards:[]},o={};e.forEach(c=>{t.totalLikes+=c.likes.length,t.totalUsers.add(c.owner._id),c.likes.forEach(i=>{t.totalUsers.add(i._id);const a=i._id,d=i.name;o[a]||(o[a]={name:d,likes:0}),o[a].likes++})});let r=0,n="—";return Object.values(o).forEach(c=>{c.likes>r&&(r=c.likes,n=c.name)}),t.maxLikes=r,t.championName=n,t.popularCards=[...e].map(c=>({id:c._id,name:c.name||"Без названия"})),t}function be(e){const t=document.querySelector(".popup-info__total-users"),o=document.querySelector(".popup-info__total-likes"),r=document.querySelector(".popup-info__max-likes"),n=document.querySelector(".popup-info__champion-name");t&&(t.textContent=e.totalUsers.size),o&&(o.textContent=e.totalLikes),r&&(r.textContent=e.maxLikes),n&&(n.textContent=e.championName);const c=document.querySelector("#popular-cards-container");if(!c)return;c.innerHTML="";const i=document.createElement("div");i.className="popup__list";const a=document.createElement("div");a.className="popup__info";const d=document.createElement("table"),y=document.createElement("tr"),C=[];for(let l=0;l<3;l++){const p=document.createElement("td"),u=document.createElement("ul");u.className="popup__info",p.appendChild(u),C.push(u),y.appendChild(p)}d.appendChild(y);const L=Math.ceil(e.popularCards.length/3);e.popularCards.forEach((l,p)=>{let u;p<L?u=0:p<L*2?u=1:u=2;const I=document.createElement("li");I.className="popup__info-item";let A=l.name;l.name.length>12&&(A=l.name.substring(0,12)+"...");const b=document.createElement("span");b.className="popup__info-term",b.textContent=A,b.title=l.name,I.appendChild(b),C[u].appendChild(I)}),a.appendChild(d),i.appendChild(a),c.appendChild(i)}function ke(){k&&V().then(e=>{const t=Le(e);be(t),m(k)}).catch(()=>{const e=document.querySelector("#popular-cards-container");e&&(e.innerHTML=""),m(k)})}ne(S);g.addEventListener("submit",ye);_.addEventListener("submit",Se);v.addEventListener("submit",Ce);me.addEventListener("submit",ve);_e.addEventListener("click",()=>{R.value=F.textContent,K.value=M.textContent,x(g,S),m(U)});$.addEventListener("click",()=>{v.reset(),x(v,S),m(B)});he.addEventListener("click",()=>{_.reset(),x(_,S),m(P)});Promise.all([V(),re()]).then(([e,t])=>{q=t._id,F.textContent=t.name,M.textContent=t.about,t.avatar&&($.style.backgroundImage=`url('${t.avatar}')`),e.forEach(o=>{z.append(j(o,{onPreviewPicture:G,onLikeIcon:Q,onDeleteCard:X,userId:q}))})}).catch(()=>{});W&&k&&W.addEventListener("click",ke);const Ee=document.querySelectorAll(".popup");Ee.forEach(e=>{Y(e)});
