(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const c of r)if(c.type==="childList")for(const s of c.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function o(r){const c={};return r.integrity&&(c.integrity=r.integrity),r.referrerPolicy&&(c.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?c.credentials="include":r.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function n(r){if(r.ep)return;r.ep=!0;const c=o(r);fetch(r.href,c)}})();const j=(e,{onPreviewPicture:t,onLikeIcon:o,onDeleteCard:n,userId:r})=>{const s=document.getElementById("card-template").content.querySelector(".card").cloneNode(!0);s.dataset.cardId=e._id;const l=s.querySelector(".card__like-button"),d=s.querySelector(".card__control-button_type_delete"),y=s.querySelector(".card__image"),C=s.querySelector(".card__like-count"),L=s.querySelector(".card__title");return y.src=e.link,y.alt=e.name,L.textContent=e.name,C&&(C.textContent=e.likes?e.likes.length:0),r&&e.likes&&e.likes.some(p=>p._id===r)&&l.classList.add("card__like-button_is-active"),r&&e.owner&&e.owner._id!==r&&d.remove(),o&&l.addEventListener("click",()=>o(l,e._id)),n&&d.addEventListener("click",()=>n(s,e._id)),t&&y.addEventListener("click",()=>t({name:e.name,link:e.link})),s},H=e=>{if(e.key==="Escape"){const t=document.querySelector(".popup_is-opened");f(t)}},m=e=>{e.classList.add("popup_is-opened"),document.addEventListener("keyup",H)},f=e=>{e.classList.remove("popup_is-opened"),document.removeEventListener("keyup",H)},Y=e=>{e.querySelector(".popup__close").addEventListener("click",()=>{f(e)}),e.addEventListener("mousedown",o=>{o.target.classList.contains("popup")&&f(e)})};function Z(e,t,o,n){const r=e.querySelector(`#${t.id}-error`);r.textContent=o,r.classList.add(n.errorClass),t.classList.add(n.inputErrorClass)}function J(e,t,o){const n=e.querySelector(`#${t.id}-error`);n.textContent="",n.classList.remove(o.errorClass),t.classList.remove(o.inputErrorClass)}function ee(e,t,o){t.validity.valid?J(e,t,o):Z(e,t,t.validationMessage,o)}function te(e){return e.some(t=>!t.validity.valid)}function O(e,t,o){te(e)?(t.classList.add(o.inactiveButtonClass),t.disabled=!0):(t.classList.remove(o.inactiveButtonClass),t.disabled=!1)}function oe(e,t){const o=Array.from(e.querySelectorAll(t.inputSelector)),n=e.querySelector(t.submitButtonSelector);O(o,n,t),o.forEach(r=>{r.addEventListener("input",function(){ee(e,r,t),O(o,n,t)})})}function ne(e){Array.from(document.querySelectorAll(e.formSelector)).forEach(o=>{oe(o,e)})}function x(e,t){const o=Array.from(e.querySelectorAll(t.inputSelector)),n=e.querySelector(t.submitButtonSelector);o.forEach(r=>{J(e,r,t)}),n.classList.add(t.inactiveButtonClass),n.disabled=!0}const i={baseUrl:"https://mesto.nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"b467a041-a34e-4276-a457-166468e85eb0","Content-Type":"application/json"}};function h(e){return e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)}function re(){return fetch(`${i.baseUrl}/users/me`,{headers:i.headers}).then(h)}function V(){return fetch(`${i.baseUrl}/cards`,{headers:i.headers}).then(h)}function ce({name:e,about:t}){return fetch(`${i.baseUrl}/users/me`,{method:"PATCH",headers:i.headers,body:JSON.stringify({name:e,about:t})}).then(h)}function se({avatar:e}){return fetch(`${i.baseUrl}/users/me/avatar`,{method:"PATCH",headers:i.headers,body:JSON.stringify({avatar:e})}).then(h)}function ie({name:e,link:t}){return fetch(`${i.baseUrl}/cards`,{method:"POST",headers:i.headers,body:JSON.stringify({name:e,link:t})}).then(h)}function le(e){return fetch(`${i.baseUrl}/cards/${e}`,{method:"DELETE",headers:i.headers}).then(h)}function ae(e,t){return fetch(`${i.baseUrl}/cards/likes/${e}`,{method:t?"DELETE":"PUT",headers:i.headers}).then(h)}const S={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},z=document.querySelector(".places__list"),U=document.querySelector(".popup_type_edit"),g=U.querySelector(".popup__form"),R=g.querySelector(".popup__input_type_name"),K=g.querySelector(".popup__input_type_description"),P=document.querySelector(".popup_type_new-card"),_=P.querySelector(".popup__form"),ue=_.querySelector(".popup__input_type_card-name"),de=_.querySelector(".popup__input_type_url"),T=document.querySelector(".popup_type_image"),D=T.querySelector(".popup__image"),pe=T.querySelector(".popup__caption"),w=document.querySelector(".popup_type_remove-card"),me=w.querySelector(".popup__form"),B=document.querySelector(".popup_type_edit-avatar"),v=B.querySelector(".popup__form"),fe=v.querySelector(".popup__input"),_e=document.querySelector(".profile__edit-button"),he=document.querySelector(".profile__add-button"),F=document.querySelector(".profile__title"),M=document.querySelector(".profile__description"),$=document.querySelector(".profile__image"),k=document.querySelector("#popup-info"),W=document.querySelector(".header__logo");let q=null,E=null,N=null;const G=({name:e,link:t})=>{D.src=t,D.alt=e,pe.textContent=e,m(T)},ye=e=>{e.preventDefault();const t=e.submitter,o=t.textContent;t.textContent="Сохранение...",ce({name:R.value,about:K.value}).then(n=>{F.textContent=n.name,M.textContent=n.about,f(U)}).catch(n=>console.log("Ошибка:",n)).finally(()=>t.textContent=o)},Ce=e=>{e.preventDefault();const t=e.submitter,o=t.textContent;t.textContent="Сохранение...",se({avatar:fe.value}).then(n=>{$.style.backgroundImage=`url('${n.avatar}')`,f(B),v.reset()}).catch(n=>console.log("Ошибка:",n)).finally(()=>t.textContent=o)},Q=(e,t)=>{const o=e.classList.contains("card__like-button_is-active"),n=e.closest(".card").querySelector(".card__like-count");let r=parseInt(n.textContent)||0;o?(e.classList.remove("card__like-button_is-active"),n.textContent=Math.max(0,r-1)):(e.classList.add("card__like-button_is-active"),n.textContent=r+1),ae(t,o).then(c=>{n.textContent=c.likes.length,e.classList.toggle("card__like-button_is-active",c.likes.some(s=>s._id===q))})},X=(e,t)=>{E=e,N=t,m(w)},ve=e=>{e.preventDefault();const t=e.submitter,o=t.textContent;t.textContent="Удаление...",E&&E.remove(),f(w),le(N).finally(()=>{t.textContent=o,E=null,N=null})},Se=e=>{e.preventDefault();const t=e.submitter,o=t.textContent;t.textContent="Создание...",ie({name:ue.value,link:de.value}).then(n=>{z.prepend(j(n,{onPreviewPicture:G,onLikeIcon:Q,onDeleteCard:X,userId:q})),f(P),_.reset(),x(_,S)}).catch(n=>console.log("Ошибка:",n)).finally(()=>t.textContent=o)};function Le(e){const t={totalUsers:new Set,totalLikes:0,maxLikes:0,championName:"—",popularCards:[]},o={};e.forEach(c=>{t.totalLikes+=c.likes.length,t.totalUsers.add(c.owner._id),c.likes.forEach(s=>{t.totalUsers.add(s._id);const l=s._id,d=s.name;o[l]||(o[l]={name:d,likes:0}),o[l].likes++})});let n=0,r="—";return Object.values(o).forEach(c=>{c.likes>n&&(n=c.likes,r=c.name)}),t.maxLikes=n,t.championName=r,t.popularCards=[...e].map(c=>({id:c._id,name:c.name||"Без названия"})),t}function be(e){const t=document.querySelector(".popup-info__total-users"),o=document.querySelector(".popup-info__total-likes"),n=document.querySelector(".popup-info__max-likes"),r=document.querySelector(".popup-info__champion-name");t&&(t.textContent=e.totalUsers.size),o&&(o.textContent=e.totalLikes),n&&(n.textContent=e.maxLikes),r&&(r.textContent=e.championName);const c=document.querySelector("#popular-cards-container");if(!c)return;c.innerHTML="";const s=document.createElement("div");s.className="popup__list";const l=document.createElement("div");l.className="popup__info";const d=document.createElement("table"),y=document.createElement("tr"),C=[];for(let a=0;a<3;a++){const p=document.createElement("td"),u=document.createElement("ul");u.className="popup__info",p.appendChild(u),C.push(u),y.appendChild(p)}d.appendChild(y);const L=Math.ceil(e.popularCards.length/3);e.popularCards.forEach((a,p)=>{let u;p<L?u=0:p<L*2?u=1:u=2;const I=document.createElement("li");I.className="popup__info-item";let A=a.name;a.name.length>12&&(A=a.name.substring(0,12)+"...");const b=document.createElement("span");b.className="popup__info-term",b.textContent=A,b.title=a.name,I.appendChild(b),C[u].appendChild(I)}),l.appendChild(d),s.appendChild(l),c.appendChild(s)}function ke(){k&&V().then(e=>{const t=Le(e);be(t),m(k)}).catch(e=>{console.log("Ошибка статистики:",e);const t=document.querySelector("#popular-cards-container");t&&(t.innerHTML=""),m(k)})}ne(S);g.addEventListener("submit",ye);_.addEventListener("submit",Se);v.addEventListener("submit",Ce);me.addEventListener("submit",ve);_e.addEventListener("click",()=>{R.value=F.textContent,K.value=M.textContent,x(g,S),m(U)});$.addEventListener("click",()=>{v.reset(),x(v,S),m(B)});he.addEventListener("click",()=>{_.reset(),x(_,S),m(P)});Promise.all([V(),re()]).then(([e,t])=>{q=t._id,F.textContent=t.name,M.textContent=t.about,t.avatar&&($.style.backgroundImage=`url('${t.avatar}')`),e.forEach(o=>{z.append(j(o,{onPreviewPicture:G,onLikeIcon:Q,onDeleteCard:X,userId:q}))})}).catch(e=>{console.log("Ошибка загрузки:",e)});W&&k&&W.addEventListener("click",ke);const Ee=document.querySelectorAll(".popup");Ee.forEach(e=>{Y(e)});
